Flow org.gluu.agama.profile.edit
     Basepath ""
// Profile edit flow starting
Log "@info Profile edit flow starting..."
// Create  variable for UI feedback
uiFeedback = {}
emailObj = {}
// Iterate x times max
Repeat 6 times max
     // Retrieve user mail  from UI
     userInput = RRF "mail.ftlh" emailObj
     // create an instance of user profile update service
     userProfileUpdateService = Call org.gluu.agama.jans.UserProfileUpdate#getInstance 
     // Check user already exist or not with mail
     user | E = Call userProfileUpdateService getUserEntity userInput.mail
     // If user found
     When user.empty is not true
          // User found with e-mail
          Log "@info User found with e-mail % " mailForm.mail
          // OTP to verify user
          otp = Call userProfileUpdateService sendMail userInput.mail
          // OTP form feedback
          otpFormFeedback = {}
          // Max 3 times repeat
          Repeat 3 times max
               // OTP Form
               otpFormData = RRF "otp.ftlh" otpFormFeedback
               // If OTP match
               When otpFormData.passcode is otp
                    // OTP matches
                    Log "@info OTP matches"
                    // Profile Update Feedback
                    profileUpdateFeedback = {}
                    // Max 3 times repeat
                    Repeat 3 times max
                         // Profile update form
                         userProfiles = RRF "profile.ftlh" profileUpdateFeedback
                         // Validate user profile inputs
                         validation = Call userProfileUpdateService validateInputs userProfiles
                         // Validation result log
                         Log "@info Validation result:  % , % , %" validation validation.valid validation.message
                         // If successfully validate
                         When validation.valid is true
                              // Update user profile
                              updateProfile = Call userProfileUpdateService updateProfile userProfiles
                              // Profile update successful
                              Log "@info Profile update successfully"
                         Otherwise
                              // Validate message
                              profileUpdateFeedback.errorMessage = validation.message
               Otherwise
                    // OTP doesn't match
                    otpFormFeedback.errorMessage = "OTP doesn't match"
     Otherwise
          // User not found
          emailObj.errorMessage = "User not found"
// Maximum attempt reached
Log "@info Maximum attempt reached"