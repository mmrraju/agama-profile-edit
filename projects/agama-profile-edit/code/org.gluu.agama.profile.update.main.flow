Flow org.gluu.agama.profile.update.main
     Basepath ""
// Profile update flow starting
Log "@info Profile update flow starting..."
// Assign veriable
uifeedback = {}
// Max x time repeat
Repeat 1 times max
     // Trigger agama-smtp flow
     Log "@info Trigger Agama-SMTP flow"
     // Trigger smtp flow
     result = Trigger org.gluu.agama.smtp.main 
     // Result from SMTP
     Log "@info Result from SMTP : %  " result
     // if result is true
     When result.success is true
          // Result is True
          Log "@info Result is true for uid : %" result.data.uid
          // create an instance of user profile update service
          userProfileEditService = Call org.gluu.agama.profile.service.UserProfileEditService#getInstance 
          // Get User details
          user = Call userProfileEditService getUserEntity result.data.uid
          // Profile update form
          userProfiles = RRF "profile.ftlh" user
          // Validate user profile inputs
          validation = Call userProfileEditService validateInputs userProfiles
          // Validation result log
          Log "@trace Validation result:  % , % , %" validation validation.valid validation.message
          // If successfully validate
          When validation.valid is true
               // Update user profile
               updateProfile | E = Call userProfileEditService updateProfile userProfiles
               //  Profile update success or not
               When updateProfile.empty is not true
                    // Profile  successfully updated
                    Log "@info Profile  successfully updated"
                    // Show acknowledgement UI page for successful update
                    ack = RRF "acknowledgement.ftlh" 
                    // Finish successfully
                    it_qakot = {success:true, data: { userId: user.uid}}
                    Finish it_qakot
               Otherwise
                    // Assign error message
                    uifeedback.errorMessage = E
                    // show error page
                    RRF "error.ftlh" E
          Otherwise
               // Assign profile validation error message
               uifeedback.errorMessage = validation.message
     Otherwise
          // Assing errro message
          uifeedback.errorMessage = "SMTP flow not found"
          // show error message
          RRF "error.ftlh" uifeedback.errorMessage
// Maximum attempt reached
Log "@info Maximum attempt reached"
// Flow finished with error 
it_cewqw = {success:false, error: "You've cross your max attempt limit"}
Finish it_cewqw